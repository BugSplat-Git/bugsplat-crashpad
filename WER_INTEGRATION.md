# Windows Error Reporting (WER) Integration

This document explains how to integrate Crashpad's built-in WER support to catch crashes that Crashpad's normal handlers might miss.

## Overview

Windows Error Reporting (WER) can catch certain types of crashes that Crashpad's in-process handlers might miss. Crashpad's WER implementation specifically handles:

- **Fail Fast Exceptions** (`STATUS_FAIL_FAST_EXCEPTION`, `0xC0000602`) - Triggered by `RaiseFailFastException()` or certain runtime checks
- **Stack Buffer Overrun** (`STATUS_STACK_BUFFER_OVERRUN`, `0xC0000409`) - Generated by stack buffer overflow protection mechanisms

These exceptions are specifically handled because they can terminate the process in ways that bypass normal exception handlers.

Crashpad provides built-in WER integration through `crashpad_wer.dll`, which implements the necessary WER callbacks and integrates seamlessly with Crashpad's crash reporting pipeline.

## Architecture

### Components

1. **`crashpad_wer.dll`** - Built automatically when compiling Crashpad on Windows
2. **WER Callbacks** - Implemented inside `crashpad_wer.dll` following Microsoft's WER API
3. **Registry Integration** - Required for Windows to recognize the WER helper module
4. **Client Registration** - Application calls `client.RegisterWerModule()` to activate

### How It Works

1. **Build Process**: Crashpad automatically builds `crashpad_wer.dll` on Windows
2. **Deployment**: Application copies the DLL to its output directory
3. **Registry Setup**: DLL path must be registered in Windows registry
4. **Runtime Registration**: Application calls `client.RegisterWerModule()` after `StartHandler()`
5. **Crash Handling**: When normal Crashpad handlers can't catch a crash, WerFault.exe loads the DLL
6. **Report Processing**: The WER helper processes the crash through Crashpad's normal pipeline

## Registry Requirements

The `crashpad_wer.dll` must be registered in the Windows registry under one of these keys:

### System-Wide (Requires Administrator Privileges)
```
Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\RuntimeExceptionHandlerModules
```

### User-Specific (No Admin Required)
```
Computer\HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\Windows Error Reporting\RuntimeExceptionHandlerModules
```

**Registry Entry Format:**
- **Key Name**: Full absolute path to `crashpad_wer.dll`
- **Value Type**: `DWORD`
- **Value Data**: `0x00000000`

**Example:**
```
Key: C:\MyApp\crashpad_wer.dll
Type: DWORD
Value: 0x0
```

## Implementation

### Registry Key Creation Function

The `createWerRegistryKey()` function handles Windows registry setup:

```cpp
bool createWerRegistryKey(const std::string& dllPath) {
    const char* registryPath = "SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\RuntimeExceptionHandlerModules";
    HKEY hKey;
    
    // Open/create the registry key under HKEY_CURRENT_USER
    LONG result = RegCreateKeyExA(HKEY_CURRENT_USER, registryPath, 0, NULL,
                                  REG_OPTION_NON_VOLATILE, KEY_WRITE, NULL, &hKey, NULL);
    
    if (result != ERROR_SUCCESS) {
        std::cerr << "Failed to open/create WER registry key. Error: " << result << std::endl;
        return false;
    }
    
    // Set the DLL path as a DWORD value with data 0x0
    DWORD value = 0x0;
    result = RegSetValueExA(hKey, dllPath.c_str(), 0, REG_DWORD,
                           reinterpret_cast<const BYTE*>(&value), sizeof(DWORD));
    
    RegCloseKey(hKey);
    return (result == ERROR_SUCCESS);
}
```

### WER Integration Setup Function

The `setupWerIntegration()` function combines registry setup and Crashpad registration:

```cpp
void setupWerIntegration(CrashpadClient& client, const std::string& exeDir) {
    std::string werDllPath = exeDir + "\\crashpad_wer.dll";
    
    if (!std::filesystem::exists(werDllPath)) {
        std::cout << "Crashpad WER DLL not found - continuing without WER integration" << std::endl;
        return;
    }
    
    // Create registry key for WER integration
    bool registryCreated = createWerRegistryKey(werDllPath);
    
    // Register WER module with Crashpad
    std::wstring werDllPathW(werDllPath.begin(), werDllPath.end());
    bool moduleRegistered = client.RegisterWerModule(werDllPathW);
    
    if (registryCreated && moduleRegistered) {
        std::cout << "Successfully set up WER integration" << std::endl;
    } else {
        std::cerr << "WER integration may not work properly" << std::endl;
    }
}
```

### Usage

The application includes the Windows-specific header and sets up WER integration after initializing Crashpad:

```cpp
#ifdef _WIN32
#include "windows.h"

// In initializeCrashpad function:
if (success) {
    setupWerIntegration(client, exeDir);
}
#endif
```

## Build Process Requirements (Windows Only)

### 1. Build Crashpad with WER Support
When building Crashpad on Windows, `crashpad_wer.dll` is automatically created.

### 2. Include Windows-Specific Files in Build
```cmake
# Add executable with platform-specific source files
if(WIN32)
    add_executable(MyCMakeCrasher main.cpp windows.cpp)
else()
    add_executable(MyCMakeCrasher main.cpp)
endif()
```

### 3. Copy DLL to Application Output
```cmake
# Example CMake to copy crashpad_wer.dll
if(WIN32)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${CRASHPAD_BUILD_DIR}/crashpad_wer.dll"
        "$<TARGET_FILE_DIR:${PROJECT_NAME}>/crashpad_wer.dll"
    )
endif()
```

### 4. Include in Symbol Uploads
Include `crashpad_wer.dll` symbols when uploading to BugSplat for complete stack traces.
